import{world}from"@minecraft/server";import{MessageFormData}from"@minecraft/server-ui";import{tpaCoolingTime}from"../config";import{color}from"../color";import{DynamicPropertyEnum}from"../DynamicProperty";import{getTimestampSecond}from"../utils/comparison";const tpaCommand={name:"tpa",desc:"传送到指定玩家身边",usage:"tpa @玩家名",handler:tpa};async function tpa(o,e){if(console.log("args",e),e.length&&!e[0].startsWith("@"))o.sendMessage(color.red("格式错误，请使用 \\tpa @玩家名 请求传送到玩家身边"));else{const n=e[0].split("@")[1];console.log("targetName",n);var r,a,e=world.getAllPlayers().find(e=>e.name===n);console.log("targetPlayer",e),n===o.name?o.sendMessage(color.red("你不能够传送到自己身边")):e?(a=o.getDynamicProperty(DynamicPropertyEnum.上次传送时间),console.log("lastUseTimestemp",a),r=Date.now(),(a=getTimestampSecond(a,r))<tpaCoolingTime?o.sendMessage(color.red(`请等待 ${Math.floor(tpaCoolingTime-a)} 秒后再次使用`)):(o.sendMessage(color.green("请求已发送")),tpaWait(e).then(e=>{world.getAllPlayers().find(e=>e.name===o.name)?(o.runCommand("tp "+n),o.sendMessage(color.green(`已传送到玩家 ${color.yellow(n)} 身边`))):o.sendMessage(color.red("找不到目标玩家"))}).catch(e=>{"UserBusy"===e?o.sendMessage(color.red("用户处于忙碌状态（正在输入框或设置等界面）")):o.sendMessage(color.red(`${color.red("玩家")} ${color.yellow(n)} `+color.red("拒绝了你的传送请求")))}),o.setDynamicProperty(DynamicPropertyEnum.上次传送时间,Date.now()))):o.sendMessage(color.red(`玩家 ${n} 不存在`))}}async function tpaWait(a){return new Promise((o,r)=>{var e=new MessageFormData;e.title(color.black("传送请求")),e.body(`${color.green("玩家")} ${color.yellow(a.name)} `+color.green("请求传送到你身边，是否接受？")),e.button1(color.green("接受")),e.button2(color.red("拒绝")),e.show(a).then(e=>{e.cancelationReason?r(e.cancelationReason):(0===e.selection?o:r)(e)})})}export{tpaCommand};